

    lua_package_path '/usr/local/Cellar/openresty/1.19.3.1_1/site/lualib/resty/?.lua;;';
    lua_package_cpath '/usr/local/Cellar/openresty/1.19.3.1_1/site/lualib/resty/?.so;;';

    server {
        listen       80;
        server_name  hd4dp.localhost.healthdata.be;
        default_type text/html;

        location = / {

        set $jwt_cookie_is_set 'false';

        access_by_lua_block {
            local cjson = require "cjson"
            local jwt = require "resty.jwt"

            local jwt_cookie_val = ngx.var.cookie_APP_TOKEN
                -- set jwt cookie if empty
            if jwt_cookie_val ~= nil then
                ngx.log(ngx.INFO, "jwt_cookie_val: " .. jwt_cookie_val)                    
            else
                
                local jwt_token = jwt:sign(
                    "YOUR_SECRET_KEY",
                    {
                        header={typ="JWT", alg="HS256"},
                        payload={user="YOUR_USER_EMAIL_OR_NAME"},
                        exp={ngx.time() + 3600}
                    }
                )

            ngx.header['Set-Cookie'] = 'APP_TOKEN=' .. jwt_token .. '; path=/'
            end
            ngx.header['X-Request-Id'] = ngx.var.request_id
        }

        if ($http_user_agent ~ MSIE) {
          return 480;
        }

        if ($http_user_agent ~ 'rv:11') {
          return 480;
        }

        content_by_lua_block {
        ngx.status = ngx.HTTP_OK
        ngx.say("<h1>Frontend App Exact match</h1>")
        }
}

        location / {

        if ($http_user_agent ~ MSIE) {
          return 480;
        }

        if ($http_user_agent ~ 'rv:11') {
          return 480;
        }

        content_by_lua_block {
        ngx.status = ngx.HTTP_OK
        ngx.say("<h1>Frontend App Slash match</h1>")
        }
}

location = /__verify_api_gateway__
    {
    internal;
    set $api_gw_authenticated_ok 'false';
    set $api_gw_debug_is_enabled 'true';
    content_by_lua_block {
            local jwt_cookie = ngx.var.cookie_APP_TOKEN
            local cjson = require "cjson"
            local jwt = require "resty.jwt"
            local jwt_obj = jwt:verify("YOUR_SECRET_KEY", jwt_cookie)
            ngx.var.api_gw_authenticated_ok = jwt_obj.verified
            
                -- enable the following line of code to see the decoded jwt object
                -- for debugging only never do this in production
            if ngx.var.api_gw_authenticated_ok == "true" then

                if ngx.var.api_gw_debug_is_enabled == "true" then
                ngx.status = ngx.HTTP_OK
--                ngx.say(jwt_cookie)
--                ngx.say(jwt_obj["verified"])
--                ngx.say(jwt_obj["reason"])

                ngx.say(cjson.encode(jwt_obj))
                end

            else
            ngx.status = ngx.HTTP_FORBIDDEN
            ngx.say("Forbidden by Sciensano API Gateway (ref __verify_api_gateway__)")
            end

            ngx.exit(ngx.HTTP_OK)
        }        
    }

location /proxy/
{
    access_by_lua_block {
    
    res1, res2 = ngx.location.capture_multi
    {
        { "/__verify_api_gateway__", { args = "auth_type=public_api_endpoint" } },
        { "/__secure_proxy__" },
    }

    if res1.status == ngx.HTTP_FORBIDDEN then
                    ngx.status = ngx.HTTP_FORBIDDEN
                    ngx.say("Forbidden by Sciensano API Gateway ref (proxy block)")
                    ngx.exit(ngx.HTTP_OK)
    else

    if res2.status == ngx.HTTP_OK then
                        ngx.status = ngx.HTTP_OK
                        ngx.print(res2.body)
                        ngx.exit(ngx.HTTP_OK)
    end

    end
    }

    }

    location /__secure_proxy__ {
            internal;
            rewrite ^/__secure_proxy__(.*) /$1 break;
            proxy_pass http://localhost:9000;
            #return 200 $request_uri;
        }

    }

    server {
        listen       9000;
        server_name  localhost;
        default_type application/json;

        location / {
        # default_type application/json;
        return 200 '{"myApiSecretData": ["This is dummy data but secret data", "This is dummy data but secret data", "This is dummy data but secret data","This is dummy data but secret data"]}';
        # return 200 $request_uri;
        }

    }
