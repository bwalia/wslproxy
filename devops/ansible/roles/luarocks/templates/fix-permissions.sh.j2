#!/bin/bash

set -x

  mkdir -p "/var/run/nginx/" \
    && chmod +x "/var/run/nginx/" \
    && chown www-data:root "/var/run/nginx/" \
    && chmod 755 -R "/var/run/nginx/"

mkdir -p "/tmp/nginx/" \
    && chmod +x "/tmp/nginx/" \
    && chown www-data:root "/tmp/nginx/" \
    && chmod 777 -R "/tmp/nginx/"

touch /var/run/nginx/nginx-reboot.log
chmod 777 /var/run/nginx/nginx-reboot.log

mkdir -p /opt/nginx/conf.d \
    && chmod 775 /opt/nginx/conf.d \
    && chown www-data:root /opt/nginx/conf.d

chmod 775 -R /usr/local/openresty/nginx/logs/ \
    && chown -R www-data:root /usr/local/openresty/nginx/logs/

chmod 775 -R /usr/local/openresty/nginx/conf/ \
    && chown -R www-data:root /usr/local/openresty/nginx/conf/

# Fix main nginx directory permissions for www-data user
chmod 775 /usr/local/openresty/nginx/ \
    && chown www-data:root /usr/local/openresty/nginx/

# Fix sbin directory permissions so www-data can execute openresty commands
chmod 755 -R /usr/local/openresty/nginx/sbin/ \
    && chown -R www-data:root /usr/local/openresty/nginx/sbin/

# Ensure PID file has correct permissions if it exists
if [ -f "/usr/local/openresty/nginx/logs/nginx.pid" ]; then
    chmod 644 /usr/local/openresty/nginx/logs/nginx.pid
    chown www-data:root /usr/local/openresty/nginx/logs/nginx.pid
fi

chmod -R 777 /opt/nginx/data/ \
    && chown -R www-data:root /opt/nginx/data/

# Create SSL config directory for Let's Encrypt certificate management
mkdir -p /opt/nginx/data/ssl/ \
    && chmod 775 -R /opt/nginx/data/ssl/ \
    && chown -R www-data:root /opt/nginx/data/ssl/

mkdir -p /opt/nginx/prod_cache/
chmod 775 -R /opt/nginx/prod_cache/
chown www-data:root -R /opt/nginx/prod_cache/

if [ -f "/tmp/.env" ]; then
  cp /tmp/.env /usr/local/openresty/nginx/html/openresty-admin/.env
fi
