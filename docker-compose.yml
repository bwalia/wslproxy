version: "3.7"
services:
  server:
    container_name: whitefalcon
    restart: always
    build:
      args:
        - APP_ENV=dev
        - APP_NAME=whitefalcon
        - DNS_RESOLVER=127.0.0.11
      context: .
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
      - "8080:80"
    networks:
      - whitefalcon-network
    volumes:
      - ./nginx-dev.conf.tmpl:/usr/local/openresty/nginx/conf/nginx.conf
      - ./openresty-admin/public:/usr/local/openresty/nginx/html/openresty-admin/public
      - ./openresty-admin/src:/usr/local/openresty/nginx/html/openresty-admin/src
      - ./openresty-admin/.eslintrc.cjs:/usr/local/openresty/nginx/html/openresty-admin/.eslintrc.cjs
      - ./openresty-admin/.gitignore:/usr/local/openresty/nginx/html/openresty-admin/.gitignore
      - ./openresty-admin/index.html:/usr/local/openresty/nginx/html/openresty-admin/index.html
      - ./openresty-admin/package.json:/usr/local/openresty/nginx/html/openresty-admin/package.json
      - ./openresty-admin/vite.config.js:/usr/local/openresty/nginx/html/openresty-admin/vite.config.js
      - ./openresty-admin/yarn.lock:/usr/local/openresty/nginx/html/openresty-admin/yarn.lock
      - ./data:/opt/nginx/data
      - ./html/swagger:/usr/local/openresty/nginx/html/swagger
      - ./api:/usr/local/openresty/nginx/html/api
      - ./.env.dev:/usr/local/openresty/nginx/html/openresty-admin/.env
    environment:
      LUA_DEBUG: "true"
      REDIS_HOST: "whitefalcon-redis"
      APP_NAME: "whitefalcon"
      VERSION: "1.0"
      STACK: "Lua 5.1"
      VITE_DEPLOYMENT_TIME: "20230510055429"
      NGINX_CONFIG_DIR: "/opt/nginx/"
      JWT_SECURITY_PASSPHRASE: "HCsKpxQ4hU97V5us5TCwvLnAVBgLqNd1dP2R-4Uywg7946J3zAqT9EOA5hdWRCQn"
      API_URL: "http://localhost:8080/api"
      HOST: "localhost"
#      DNS_RESOLVER: "127.0.0.11"       # Docker's internal DNS resolver IP this should only be added for Docker deployments

  redis:
    container_name: whitefalcon-redis
    image: "redis:alpine"
    ports:
      - "6379:6379"
    networks:
      - whitefalcon-network

  cdn_node:
    container_name: cdn-node
    build:
      context: ./demos-origins/node-app
      dockerfile: Dockerfile
    ports:
      - "3009:3009"
networks: 
  whitefalcon-network: